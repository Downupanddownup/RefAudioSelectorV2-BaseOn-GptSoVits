<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>测试 - Layui</title>
  <link rel="stylesheet" href="web/js/layui/css/layui.css">
  <link rel="stylesheet" href="web/pages/style/commonStyle.css">
</head>
<body>

<div id="contentHeader">
  <div class="layui-collapse" lay-accordion="">
    <div class="layui-colla-item">
      <div class="layui-colla-title" style="display: flex;justify-content: space-between">
        <div>基础信息</div>
        <div>
          
        </div>
      </div>
      <div class="layui-colla-content">
<!--        layui-show-->
        <table class="table1">
          <tr>
            <td style="text-align: center">
              <div id="roleList" style="width: 200px"></div>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
    <ul class="layui-tab-title">
      <li class="layui-this" lay-id="1">参考音频</li>
      <li lay-id="2" >推理任务</li>
      <li lay-id="3" >结果评测</li>
      <li lay-id="4" >长文推理</li>
      <li lay-id="5" >音频打包</li>
    </ul>
    <div class="layui-tab-content" style="height: 100px;">
      <div class="layui-tab-item layui-show"><div id="referenceAudioView"></div></div>
      <div class="layui-tab-item"><div id="inferenceTaskView"></div></div>
      <div class="layui-tab-item"><div id="resultEvaluationView"></div></div>
      <div class="layui-tab-item"><div id="longTextInferenceView"></div></div>
      <div class="layui-tab-item"><div id="audioPackagingView"></div></div>
    </div>
  </div>
</div>


<!-- body 末尾处引入 layui -->
<script src="web/js/layui/layui.js"></script>
<script src="web/js/echarts/echarts.min.js"></script>
<script src="web/js/xm_select/xm-select.js"></script>
<script src="web/js/jquery/jquery-3.7.1.min.js"></script>
<script src="web/js/wavesurfer/wavesurfer.min.js"></script>
<script src="web/js/wavesurfer/regions.min.js"></script>
<script src="web/js/wavesurfer/timeline.min.js"></script>
<script src="web/js/wavesurfer/hover.min.js"></script>
<script src="web/js/wavesurfer/spectrogram.min.js"></script>
<script src="web/js/wavesurfer/zoom.min.js"></script>
<script src="web/js/wavefile/wavefile.js"></script>
<script src="web/pages/common/common_jquery.js"></script>
<script src="web/config.js"></script>
<script src="web/pages/bean/common_bean.js"></script>
<script src="web/pages/common/util.js"></script>
<script src="web/pages/common/audio.js"></script>
<script src="web/pages/common/wavesurfer.js"></script>
<script>
  

  
  window.onload = function(){
    layui.use(function(){
      
      CommonSpace.customJquery($)
      CommonSpace.loadHtmls([
              'web/pages/business/audio_packaging/audio_packaging.html',
              'web/pages/business/inference_task/inference_task.html',
              'web/pages/business/inference_task/task_detail.html',
              'web/pages/business/inference_task/reference_select.html',
              'web/pages/business/inference_task/text_manager.html',
              'web/pages/business/inference_task/inference_task_result_audio_list.html',
              'web/pages/business/long_text_inference/long_text_inference.html',
              'web/pages/business/long_text_inference/inference_params_edit.html',
              'web/pages/business/long_text_inference/long_text_deal_with.html',
              'web/pages/business/long_text_inference/long_text_refer_audio_select.html',
              'web/pages/business/long_text_inference/long_text_result_audio_select.html',
              'web/pages/business/long_text_inference/long_text_select.html',
              'web/pages/business/reference_audio/reference_audio.html',
              'web/pages/business/reference_audio/reference_audio_edit.html',
              'web/pages/business/reference_audio/reference_audio_split.html',
              'web/pages/business/reference_audio/reference_audio_compare.html',
              'web/pages/business/reference_audio/report_result.html',
              'web/pages/business/result_evaluation/result_evaluation.html',
              'web/pages/business/result_evaluation/result_audio_list.html',
              'web/pages/business/result_evaluation/result_audio_all_detail.html',
              'web/pages/business/sound_fusion/sound_fusion_edit.html',
              'web/pages/business/sound_fusion/sound_fusion_manager.html',
              'web/pages/business/sound_fusion/sound_fusion_select.html'
      ],function () {
        layui.element.on('tab(docDemoTabBrief)', function (data) {
          console.log($(this).html()); // 当前 tab 标题所在的原始 DOM 元素
          console.log(data.index); // 得到当前 tab 项的所在下标
          console.log(data.elem); // 得到当前的 tab 容器
          console.log(data.id); // 得到当前的 tab ID(2.9.11+)
          
          const html = $(this).html()
          
          $('#referenceAudioView').html('')
          $('#inferenceTaskView').html('')
          $('#resultEvaluationView').html('')
          $('#longTextInferenceView').html('')
          $('#audioPackagingView').html('')
          
          if (html == '参考音频') {
            ReferenceAudioSpace.getReferenceAudio('referenceAudioView').loadData()
          } else if (html == '推理任务') {
            InferenceTaskSpace.getInferenceTask('inferenceTaskView').render()
          } else if (html == '结果评测') {
            ResultEvaluationSpace.getResultEvaluation('resultEvaluationView').loadData()
          } else if (html == '长文推理') {
            LongTextInferenceSpace.getLongTextInference('longTextInferenceView').render()
          } else if (html == '音频打包') {
            AudioPackagingSpace.getAudioPackaging('audioPackagingView').render()
          }
          
        });

        loadRoleName()
        
      })
      
      
      function loadRoleName() {
        $.customAjax({
          url: BaseUrl+'system/load_last_role_name',
          type: 'post',
          success: function(res){
            if (res.code == 0) {
              console.log(res)
              initRoleList(res.data.roleName, res.data.roleList)
              layui.element.tabChange('docDemoTabBrief', 1);
            } else {
              layui.layer.msg(res.msg)
            }
          },
          error: function(res, msg){
            layui.layer.msg(msg)
          }
        })
      }
      
      let SelectDataList = []
      
      function initRoleList(roleName, roleList) {

        const data = roleList.map(item => {
          return {
            name: item,
            value: item,
            selected: item === roleName
          }
        })
        SelectDataList = data
        
        
        console.log(data)

        xmSelect.render({
          el: '#roleList',
          tips: '选择或新建',
          searchTips: '选择或新建',
          radio: true,
          clickClose: true,
          filterable: true,
          create: function(val, arr){
            if(arr.length === 0){
              return {
                name: val,
                value: val,
              }
            }
          },
          model: {
            icon: 'hidden',
            label: {
              type: 'text',
            }
          },
          data: data,
          on: function(data){
            //arr:  当前多选已选中的数据
            const arr = data.arr;
            //change, 此次选择变化的数据,数组
            const change = data.change;
            //isAdd, 此次操作是新增还是删除
            const isAdd = data.isAdd;

            //可以return一个数组, 代表想选中的数据
            //return []
            console.log('xm-select', data)
            const selectedRoleName = arr[0].name
            
            if (selectedRoleName) {
              $.customAjax({
                url: BaseUrl + 'system/switch_role_workspace',
                type: 'POST',
                data: {
                  roleName: selectedRoleName
                },
                success: function (data) {
                  if (data.code == 0) {
                    layui.layer.msg('切换成功')
                    if (!SelectDataList.find(item => item.value === selectedRoleName)) {
                      SelectDataList.forEach(item => item.selected = false)
                      SelectDataList.push({
                        name: selectedRoleName,
                        value: selectedRoleName,
                        selected: true
                      })
                    }
                    xmSelect.get('#roleList', true).update({
                      data:SelectDataList
                    })
                    layui.element.tabChange('docDemoTabBrief', 1);
                  } else {
                    layui.layer.msg(data.msg)
                  }
                }
              })
            }
            
          },
        })
      }
      

      $(document).keydown(function(event) {
        // 检查是否按下了 Esc 键
        if (event.which === 27) {
          // 执行你需要的操作
          // alert('Esc 键被按下！');

          layui.layer.closeLast();
          
          return false; // 阻止默认行为
        }
      });
      
    });
  }
  
</script>
</body>
</html>
