<!DOCTYPE html>
<script>
    const ResultAudioListSpace = (function () {
        
        class C_LevelData {
            constructor(data) {
                this.compareType = data.compareType || '';//对比参数
                this.obj = data.obj || null;
                this.type = data.type || 0;//1 参考音频；2 推理文本； 3 对比参数
                this.level = data.level || 0;// 等级
                this.subLevelList = data.subLevelList || [];// 子级
                this.selected = data.selected || false;
                this.resultAudio = null
            }
            
            getHtml(isInTable){
                if (this.type == 1) {
                    const maxWidth = isInTable ? '400px' : 'auto'
                    return `

<div class="limited-width" style="max-width: ${maxWidth}">
<button type="submit" class="layui-btn layui-btn-sm" data-reference-audio="${this.obj.audioPath}" data-reference-audio-content="${this.obj.audioContent}">参考音频</button> 
                    <span  >${this.obj.audioContent}</span>
</div>

`
                }
                if (this.type == 2) {
                    return `${this.obj.textContent}`
                }
                if (this.type == 3) {
                    return `${this.obj.getShowTxt(this.compareType)}`
                }
                return ''
            }
            getTitle(){
                if (this.type == 1) {
                    return `参考内容`
                }
                if (this.type == 2) {
                    return `推理文本`
                }
                if (this.type == 3) {
                    return `对比变量`
                }
                return ''
            }
        }
        
        class C_ResultAudioList {
            constructor(viewId, C_ObjInferenceTaskResultAudioFilter$1) {
                this.viewId = viewId
                this.task = null
                this.taskResultAudioList = []
                this.audioFilter = C_ObjInferenceTaskResultAudioFilter$1
                this.levelDeep = 3
                this.levelDatas = []
                this.audioController= new AudioController()
            }

            loadData(){
                const _this = this

                $.customAjax({
                    url: BaseUrl+'evaluation/get_result_evaluation_list',
                    type: 'post',
                    data:{
                        taskId: _this.audioFilter.taskId,
                        compareParamIds: _this.audioFilter.compareParamIds.join(','),
                        audioIds: _this.audioFilter.audioIds.join(','),
                        textIds: _this.audioFilter.textIds.join(','),
                        audioLengthStart: _this.audioFilter.audioLengthStart,
                        audioLengthEnd: _this.audioFilter.audioLengthEnd,
                        asrSimilarScoreStart: _this.audioFilter.asrSimilarScoreStart,
                        asrSimilarScoreEnd: _this.audioFilter.asrSimilarScoreEnd,
                        audioSimilarScoreStart: _this.audioFilter.audioSimilarScoreStart,
                        audioSimilarScoreEnd: _this.audioFilter.audioSimilarScoreEnd,
                        scoreStart: _this.audioFilter.scoreStart,
                        scoreEnd: _this.audioFilter.scoreEnd,
                        longTextScoreStart: _this.audioFilter.longTextScoreStart,
                        longTextScoreEnd: _this.audioFilter.longTextScoreEnd,
                        remark: _this.audioFilter.remark,
                        order: _this.audioFilter.audioSort,
                        desc: _this.audioFilter.audioUpDown
                    },
                    success: function(res){
                        if (res.code == 0) {
                            
                            
                            _this.task = new C_ObjInferenceTask(res.data.task)
                            _this.taskResultAudioList = res.data.audioList ? res.data.audioList.map(i => new C_ObjInferenceTaskResultAudio(i)) : []
                            _this.levelDeep = _this.task.compareType === 'refer_audio' ? 2 : 3
                            
                            _this.levelDatas = _this.createLevelData()

                            console.log(_this)

                            _this.render()
                        } else {
                            layui.layer.msg(res.msg)
                        }
                    },
                    error: function(res, msg){
                        layui.layer.msg(msg)
                    }
                })
            }
            render() {
                const _this = this
                const getTpl = $('#resultAudioListTemplate').html();
                // 渲染并输出结果
                layui.laytpl(getTpl).render(_this, function(html){
                    const obj = $('#'+_this.viewId)
                    obj.html(html)

                    layui.element.render('collapse');

                    obj.find('td[data-audio-path]').on('click', function (){
                        const resultId = $(this).attr('data-audio-path')
                        if ($(this).html().trim() === '') {
                            _this.loadAudio($(this), resultId)
                        }
                    })

                    obj.find('td[id^=audio-different-]').on('click', function (){
                        const target = $(this).parent().find('td[data-audio-path]')
                        const resultId = target.attr('data-audio-path')
                        if (target.html().trim() === '') {
                            _this.loadAudio(target, resultId)
                        }
                    })
                    
                    obj.find('[data-reference-audio]').on('click',function () {

                        // 阻止事件冒泡到父级元素
                        event.stopPropagation();
                        
                        const path = $(this).attr('data-reference-audio')
                        const content = $(this).attr('data-reference-audio-content')
                        _this.showReferenceAudio(path,content)
                    })

                    let currentSelectedRow = null; // 用来存储当前选中的行

                    // 使用jQuery选择所有具有class为list-item的行
                    obj.find('tr[id^=result-audio-]').on('click', function() {
                        // 如果之前有选中的行，先移除其样式
                        if (currentSelectedRow) {
                            $(currentSelectedRow).removeClass('selected');
                        }

                        // 添加或移除当前行的选中样式
                        $(this).toggleClass('selected');

                        // 更新当前选中的行
                        currentSelectedRow = this;

                    });
                    
                    obj.find('div[id^=audio-score-]').each(function(){
                        const id = $(this).attr('id').replace('audio-score-', '')
                        const resultAudio = _this.taskResultAudioList.find(i => i.id == id)
                        layui.rate.render({
                            elem: '#audio-score-'+id,
                            value: resultAudio.score,
                            choose: function(value){
                                console.log('评分',value); // 获得选中的评分值
                                _this.updateResultAudioScore(id, value)
                            }
                        });
                    })
                    
                    obj.find('i[data-audio-remark-edit]').on('click', function(){
                        const id = $(this).attr('data-audio-remark-edit')
                        _this.showEditRemarkDialog(id)
                    })
                    
                });
            }

            showEditRemarkDialog(id){
                const _this = this
                const resultAudio = _this.taskResultAudioList.find(i => i.id == id)

                const dialogIndex = layui.layer.open({
                    type: 1,
                    area: ['600px', '400px'],
                    content: `
                        <table class="table1">
                             <tr>
                                  <td>
                                       <textarea id="audioRemarkEdit" placeholder="请输入备注" class="layui-textarea">${resultAudio.remark}</textarea>
                                </td>
                            </tr>
                        </table>
                `,
                    btn: ['确认', '取消'],
                    yes: function(){
                        const remark = $('#audioRemarkEdit').val()
                        console.log('remark', remark)
                        $.customAjax({
                            url: BaseUrl + 'evaluation/update_result_audio_remark',
                            type: 'POST',
                            data: {
                                id: id,
                                remark: remark
                            },
                            success: function (data) {
                                if (data.code == 0) {
                                    layui.layer.msg('保持成功')
                                    layui.layer.close(dialogIndex)
                                    resultAudio.remark = remark
                                    $('#' + _this.viewId + ' #data-audio-remark-span-'+id).html(remark)
                                } else {
                                    layui.layer.msg(data.msg)
                                }
                            }
                        })
                    }
                });
                
            }

            updateResultAudioScore(id, score){
                const _this = this
                $.customAjax({
                    url: BaseUrl + 'evaluation/update_result_audio_score',
                    type: 'POST',
                    data: {
                        id: id,
                        score: score
                    },
                    success: function (data) {
                        if (data.code == 0) {
                            const resultAudio = _this.taskResultAudioList.find(i => i.id == id)
                            resultAudio.score = score
                        } else {
                            layui.layer.msg(data.msg)
                        }
                    }
                })
            }

            showReferenceAudio(path,content){
                const _this = this

                const dialogIndex = layer.open({
                    type: 1,
                    area: ['600px', '400px'],
                    content: `
                        <table class="table1">
                             <tr>
                                  <td>
                                      <audio id="referenceAudio" controls style="width: 350px;height: 30px;margin: 0 0">
                                        <source src="${path.replace(/\\/g, '/')}" type="audio/mpeg">
                                        您的浏览器不支持音频播放。
                                    </audio>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    ${content}
                                </td>
                            </tr>
                        </table>
                `,
                    btn: ['关闭'],
                    yes: function(){
                        layui.layer.close(dialogIndex)
                    }
                });

                const audioElement = document.getElementById(`referenceAudio`);

                _this.audioController.registerEventListener(audioElement)

                _this.audioController.dispatchClickEvent(audioElement);
                
            }

            loadAudio(divElement, resultId){
                const _this = this
                if (divElement.html().trim() !== '') {
                    return
                }
                const entry = _this.taskResultAudioList.find(item => item.id == resultId)
                divElement.html(`
                         <audio id="audio-${entry.id}" controls style="width: 350px;height: 30px;margin: 0 0">
                            <source src="${entry.path.replace(/\\/g, '/')}" type="audio/mpeg">
                            您的浏览器不支持音频播放。
                        </audio>
                `)

                const div = document.getElementById(`result-audio-${entry.id}`);

                const contentElement = div.querySelector(`#audio-different-${entry.id}`);
                const audioElement = div.querySelector(`#audio-${entry.id}`);

                contentElement.addEventListener('click', function () {
                    _this.audioController.dispatchClickEvent(audioElement);
                });

                _this.audioController.registerEventListener(audioElement)
            }
            
            createLevelData() {
                const _this = this
                //1 参考音频；2 推理文本； 3 对比参数
                const textObj = {
                    list: _this.task.taskTextList,
                    type:2
                }
                const audioObj = {
                    list: _this.task.taskAudioList,
                    type:1
                }
                const compareParamObj = {
                    list: _this.task.compareParams,
                    type:3
                }
                if (_this.levelDeep == 2) {
                    if (_this.audioFilter.includeSort == 6) {//推理文本->参考音频
                        return _this.generateTwoLevelData(textObj, audioObj)
                    } else if (_this.audioFilter.includeSort == 7) {//参考音频->推理文本
                        return _this.generateTwoLevelData(audioObj, textObj)
                    }
                } else {
                    if (_this.audioFilter.includeSort == 0) {//参考音频->推理文本->比对参数
                        return _this.generateThreeLevelData(audioObj, textObj, compareParamObj)
                    } else if (_this.audioFilter.includeSort == 1) {//参考音频->比对参数->推理文本
                        return _this.generateThreeLevelData(audioObj, compareParamObj, textObj)
                    } else if (_this.audioFilter.includeSort == 2) {//比对参数->推理文本->参考音频
                        return _this.generateThreeLevelData(compareParamObj, textObj, audioObj)
                    } else if (_this.audioFilter.includeSort == 3) {//比对参数->参考音频->推理文本
                        return _this.generateThreeLevelData(compareParamObj, audioObj, textObj)
                    } else if (_this.audioFilter.includeSort == 4) {//推理文本->参考音频->比对参数
                        return _this.generateThreeLevelData(textObj, audioObj, compareParamObj)
                    } else if (_this.audioFilter.includeSort == 5) {//推理文本->比对参数->参考音频
                        return _this.generateThreeLevelData(textObj, compareParamObj, audioObj)
                    }
                }
                return []
            }
            
            generateTwoLevelData(firstRow, secondRow){
                const _this = this
                let levelData = firstRow.list.map(first => {
                    const level = new C_LevelData({
                        compareType: _this.task.compareType,
                        obj: first,
                        type: firstRow.type,
                        level: 1
                    })
                    level.subLevelList = secondRow.list.map(second => {
                        const twoLevel = new C_LevelData({
                            compareType: _this.task.compareType,
                            obj: second,
                            type: secondRow.type,
                            level: 2
                        })
                        //1 参考音频；2 推理文本； 3 对比参数
                        const firstId = first.id
                        const secondId = second.id
                        if (firstRow.type == 1) {
                            twoLevel.resultAudio = _this.taskResultAudioList.find(audio => audio.audioId == firstId && audio.textId == secondId)
                        } else if (firstRow.type == 2) {
                            twoLevel.resultAudio = _this.taskResultAudioList.find(audio => audio.textId == firstId && audio.audioId == secondId)
                        }
                        
                        return twoLevel
                    })
                    return level
                })
                levelData.forEach(i => {
                    i.subLevelList = i.subLevelList.filter(j => j.resultAudio != null)
                })
                levelData = levelData.filter(i => i.subLevelList.length > 0)
                return levelData
            }
            
            generateThreeLevelData(firstRow, secondRow, threeRow){
                const _this = this
                let levelData = firstRow.list.map(first => {
                    const level = new C_LevelData({
                        compareType: _this.task.compareType,
                        obj: first,
                        type: firstRow.type,
                        level: 1
                    })
                    level.subLevelList = secondRow.list.map(second => {
                        const twoLevel = new C_LevelData({
                            compareType: _this.task.compareType,
                            obj: second,
                            type: secondRow.type,
                            level: 2
                        })
                        twoLevel.subLevelList = threeRow.list.map(three => {
                            const threeLevel = new C_LevelData({
                                compareType: _this.task.compareType,
                                obj: three,
                                type: threeRow.type,
                                level: 3
                            })
                            //1 参考音频；2 推理文本； 3 对比参数
                            let textId = 0;
                            let audioId = 0;
                            let compareParamId = 0;
                            if (firstRow.type == 1) {
                                audioId = first.id
                            } else if (firstRow.type == 2) {
                                textId = first.id
                            } else if (firstRow.type == 3) {
                                compareParamId = first.id
                            }
                            if (secondRow.type == 1) {
                                audioId = second.id
                            } else if (secondRow.type == 2) {
                                textId = second.id
                            } else if (secondRow.type == 3) {
                                compareParamId = second.id
                            }
                            if (threeRow.type == 1) {
                                audioId = three.id
                            } else if (threeRow.type == 2) {
                                textId = three.id
                            } else if (threeRow.type == 3) {
                                compareParamId = three.id
                            }
                            threeLevel.subLevelList = _this.taskResultAudioList.filter(audio => audio.textId == textId && audio.audioId == audioId && audio.compareParamId == compareParamId)
                            return threeLevel
                        })
                        return twoLevel
                    })
                    return level
                })
                levelData.forEach(i => {
                    i.subLevelList.forEach(j => {
                        j.subLevelList = j.subLevelList.filter(k => k.subLevelList.length > 0)
                    })
                })
                levelData.forEach(i => {
                    i.subLevelList = i.subLevelList.filter(j => j.subLevelList.length > 0)
                })
                levelData = levelData.filter(i => i.subLevelList.length > 0)
                return levelData
            }

            getFirstLevelData(){
                return this.levelDatas
            }
            
        }

        function getResultAudioList(viewId, C_ObjInferenceTaskResultAudioFilter$1) {
            return new C_ResultAudioList(viewId, C_ObjInferenceTaskResultAudioFilter$1)
        }

        return {
            getResultAudioList: getResultAudioList
        }
    })()
</script>
<script id="resultAudioListTemplate" type="text/html">
    
    {{# if (d.taskResultAudioList.length < 1) { }}
    <div class="no-data">暂无数据</div>
    {{# } else { }}
        
        {{# if(d.levelDeep == 2){ }}
        
            <div class="layui-collapse">
        
        
                {{# layui.each(d.getFirstLevelData(), function(index, item){ }}
        
                <div class="layui-colla-item">
                    <div class="layui-colla-title">{{- item.getHtml(false)}}</div>
                    <div class="layui-colla-content {{isTrue(item.selected,'layui-show','')}}">
                        
                        <table id="audioList" class="table2" >

                            {{# layui.each(item.subLevelList, function(index2, item2){ }}
                            
                                {{# if(index2 == 0) { }}
    
                                    <tr style="height: 46px" class="first-row">
                                        <td style="width: 5%">序号</td>
                                        <td style="width: 8%;">评分</td>
                                        <td style="width: 20%;min-width: 380px">推理音频</td>
                                        <td style="width: 15%">{{item2.getTitle()}}</td>
                                        <td style="width: 5%;">时长</td>
                                        <td style="width: 5%;">文本相似度</td>
                                        <td style="width: 5%;">音频相似度</td>
                                        <td style="width: 10%;">备注</td>
                                    </tr>
                                
                                {{# } }}
                            
                            <tr id="result-audio-{{item2.resultAudio.id}}" style="height: 46px">
                                <td>{{index2+1}}</td>
                                <td><div id="audio-score-{{item2.resultAudio.id}}" class="no-wrap"></div></td>
                                <td data-audio-path="{{item2.resultAudio.id}}" style="width: 350px;cursor: pointer"></td>
                                <td id="audio-different-{{item2.resultAudio.id}}" style="text-align: left;" class="single-line">{{- item2.getHtml(true)}}</td>
                                <td>{{item2.resultAudio.audioLength}}</td>
                                <td>{{item2.resultAudio.asrSimilarScore}}</td>
                                <td>{{item2.resultAudio.audioSimilarScore}}</td>
                                <td><span id="data-audio-remark-span-{{item2.resultAudio.id}}">{{item2.resultAudio.remark}}</span><i class="layui-icon layui-icon-edit" data-audio-remark-edit="{{item2.resultAudio.id}}"></i> </td>
                            </tr>
                            {{# }) }}
                        </table>
                        
                    </div>
                </div>
        
                {{# }) }}
        
            </div>
        
        
        {{# } else if (d.levelDeep == 3) { }}
    
        <div class="layui-collapse">
    
            
            {{# layui.each(d.getFirstLevelData(), function(index, item){ }}
    
                <div class="layui-colla-item">
                    <div class="layui-colla-title">{{item.getHtml()}}</div>
                    <div class="layui-colla-content {{isTrue(item.selected,'layui-show','')}}">
        
                        {{# layui.each(item.subLevelList, function(index2, item2){ }}
    
                            <div class="layui-collapse">
                                <div class="layui-colla-item">
                                    <div class="layui-colla-title">{{item2.getHtml()}}</div>
                                    <div class="layui-colla-content {{isTrue(item2.selected,'layui-show','')}}">
                                        
                                        <table id="audioList" class="table2" >
                                            <tr style="height: 46px">
                                                <td>序号</td>
                                                <td>推理音频</td>
                                                <td>差异</td>
                                                <td>时长</td>
                                                <td>文本相似度</td>
                                                <td>音频相似度</td>
                                                <td>评分</td>
                                                <td>备注</td>
                                            </tr>
                                            {{# layui.each(item2.subLevelList, function(index3, item3){ }}
                                                <tr id="result-audio-{{item3.id}}" style="height: 46px">
                                                    <td>{{index3+1}}</td>
                                                    <td data-audio-path="{{item3.resultAudio.id}}" style="width: 350px;cursor: pointer"></td>
                                                    <td>{{- item3.resultAudio.getHtml()}}</td>
                                                    <td>{{item3.resultAudio.audioLength}}</td>
                                                    <td>{{item3.resultAudio.asrSimilarScore}}</td>
                                                    <td>{{item3.resultAudio.audioSimilarScore}}</td>
                                                    <td>{{item3.resultAudio.score}}</td>
                                                    <td>{{item3.resultAudio.remark}}</td>
                                                </tr>
                                            {{# }) }}
                                        </table>
                                        
                                    </div>
                                </div>
                            </div>
                        
                        {{# }) }}
        
                    </div>
                </div>
            
            {{# }) }}
            
        </div>
        
        
        {{# } }}
    
    {{# } }}
    
    
    
</script>