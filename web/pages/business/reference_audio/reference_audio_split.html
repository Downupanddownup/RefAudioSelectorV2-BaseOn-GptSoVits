<!DOCTYPE html>
<script>
  const ReferenceAudioSplitSpace = (function () {
    
    class C_AudioFragment {
      constructor(data) {
        this.id = data.id || ''
        this.region = data.region || null
        this.frament = new C_ObjReferenceAudio(data.originAudio)
      }
    }
    
    class C_Audio {
      constructor(data) {
        this.index = data.index || 0
        this.blob = data.blob || null
        this.originAudio = data.originAudio || null
        this.wavesurfer = null
        this.regionsManager = null
      }
    }
    
    class C_Region {
      constructor(data) {
        this.region = data.region || null
      }
    }
    
    class C_ReferenceAudioSplit {
      constructor(viewId, originAudio) {
        this.viewId = viewId
        this.originAudio = originAudio
        this.wavesurfer = null
        this.regionsManager = null
        this.regions = []
        this.blob = null
      }

      render() {
        const _this = this
        const getTpl = $('#referenceAudioSplitTemplate').html(); // 获取模板字符
        // 渲染并输出结果
        layui.laytpl(getTpl).render(_this, function(html){
          const obj = $('#'+_this.viewId)
          obj.html(html)
          
          _this.loadAudio()
          
          obj.find('#addRegion').on('click',function(){
            _this.addRegion()
          })
          
          obj.find('#splitAudio').on('click',function(){
            _this.splitAudio()
          })

          
        });
        return _this
      }

      splitAudio(){
        const _this = this

        $('#' + _this.viewId + ' #audioDiv').html(``)
        
        _this.regions.forEach(item => {

          extractAudioSegment(_this.blob, item.region.start, item.region.end).then(blob => {
            console.log('blob', blob)
            const url = URL.createObjectURL(blob); // 更新音频文件的 URL

            $('#' + _this.viewId + ' #audioDiv').append(`
              <audio controls class="custom-audio">
                <source src="${url}" type="audio/wav">
                <!-- 提供备用内容，比如浏览器不支持<audio>标签时显示的信息 -->
                您的浏览器不支持 HTML5 audio 标签。
              </audio>
            `)
            
          })
          
        })
        
       
      }

      addRegion(){
        const _this = this
        const region = _this.regionsManager.addRegion({
          start: 0,
          end: _this.originAudio.audioLength,
          content: '剪切范围',
          color: _this.randomColor(),
          // minLength: 1,
          // maxLength: 10,
        })
        
        _this.regions.push(new C_Region({
          region: region
        }))
        
      }
      
      async loadAudio() {
        const _this = this
        const {audioUrl, audioBlob} = await fetchAudioBlob(_this.originAudio.audioPath)
        _this.initWaveform(audioUrl, audioBlob)
      }

      initWaveform(audioUrl, audioBlob){
        const _this = this

        const audio = new Audio()


        audio.src = audioUrl; // 更新音频文件的 URL
        
        
        
        _this.blob = audioBlob
        
        // Create a second timeline
        const bottomTimeline = WaveSurfer.Timeline.create({
          height: 10,
          timeInterval: 0.1,
          primaryLabelInterval: 1,
          style: {
            fontSize: '10px',
            color: '#6A3274',
          },
        })
        
        const hover =  WaveSurfer.Hover.create({
                  lineColor: '#ff0000',
                  lineWidth: 2,
                  labelBackground: '#555',
                  labelColor: '#fff',
                  labelSize: '11px',
                })

        _this.regionsManager = WaveSurfer.Regions.create()

        // Create an instance of WaveSurfer 
        _this.wavesurfer = WaveSurfer.create({
          container: '#waveform',
          waveColor: 'rgb(200, 0, 200)',
          progressColor: 'rgb(100, 0, 100)',
          media: audio,
          minPxPerSec: 100,
          // sampleRate: 32000,
          plugins: [bottomTimeline,hover,_this.regionsManager],
        })

        console.log('wavesurfer')
        document.body.appendChild(audio)

        // Initialize the Spectrogram plugin
   /*     _this.wavesurfer.registerPlugin(
                WaveSurfer.Spectrogram.create({
                  labels: true,
                  height: 200,
                  splitChannels: true,
                })
        )*/
        
        
      }

      randomColor() {
        const random = (min, max) => Math.random() * (max - min) + min
        return `rgba(${random(0, 255)}, ${random(0, 255)}, ${random(0, 255)}, 0.5)`
      }

     

      

    }

    function getReferenceAudioSplit(viewId, originAudio) {//
      return new C_ReferenceAudioSplit(viewId, originAudio)
    }

    return {
      getReferenceAudioSplit: getReferenceAudioSplit
    }
  })()
</script>

<script id="referenceAudioSplitTemplate" type="text/html">
  <div>
    是否保留原始音频：
    <label class="custom-radio" style="margin-right: 30px">
      <input type="radio" name="streamMode" value="是" title="是" {{d ? 'checked' : ''}}>
      <span></span>是
    </label>
    <label class="custom-radio">
      <input type="radio" name="streamMode" value="否" title="否" {{d ? '' : 'checked'}}>
      <span></span>否
    </label>
  </div>
  
  <div id="waveformListView">
    
  </div>
  
  <button type="submit" class="layui-btn layui-btn-sm" id="splitAudio">添加一个新的</button>
  <button type="submit" class="layui-btn layui-btn-sm" id="splitAudio">提取音频</button>
  
</script>

<script id="referenceAudioSplitItemTemplate" type="text/html">
  
  <div data-wave-form="{{d.index}}"></div>
  <div>
    <button type="submit" class="layui-btn layui-btn-sm" data-add-audio-fragment="{{d.index}}">添加片段选择</button>
  </div>
  
  <div data-audio-result="{{d.index}}"></div>
  
  <table class="table1">
    <tr>
      <td>音频分类：</td>
      <td><input type="text" autocomplete="off" id="searchAudioName" placeholder="音频分类" class="layui-input" style="width: auto;"></td>
      <td>音频内容：</td>
      <td><input type="text" autocomplete="off" id="searchAudioName" placeholder="音频内容" class="layui-input" style="width: auto;"></td>
      <td>音频语种：</td>
      <td><input type="text" autocomplete="off" id="searchAudioName" placeholder="音频语种" class="layui-input" style="width: auto;"></td>
    </tr>
  </table>

  <div>
    <button type="submit" class="layui-btn layui-btn-sm" data-delete-audio="{{d.index}}">删除</button>
  </div>
  
</script>